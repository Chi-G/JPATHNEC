name: Deploy to GO54 Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual deployment from GitHub Actions tab

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to GO54 Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "================================================"
            echo "Starting deployment to jpathnec.com"
            echo "================================================"
            
            echo "Navigating to project directory..."
            cd /home2/jpathne1/public_html
            
            echo "Pulling latest code from GitHub..."
            git pull origin main
            
            echo "Installing Composer dependencies..."
            /opt/cpanel/ea-php83/root/usr/bin/php composer.phar install --no-dev --optimize-autoloader --no-interaction
            
            echo "Running database migrations..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan migrate --force
            
            echo "Creating storage symlink..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan storage:link --force
            
            echo "Clearing application cache..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan config:clear
            /opt/cpanel/ea-php83/root/usr/bin/php artisan cache:clear
            /opt/cpanel/ea-php83/root/usr/bin/php artisan route:clear
            /opt/cpanel/ea-php83/root/usr/bin/php artisan view:clear
            
            echo "Rebuilding optimized cache..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan config:cache
            /opt/cpanel/ea-php83/root/usr/bin/php artisan route:cache
            /opt/cpanel/ea-php83/root/usr/bin/php artisan view:cache
            
            echo "Restarting queue workers..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan queue:restart
            
            echo "Setting proper permissions..."
            chmod -R 775 storage bootstrap/cache
            
            echo "================================================"
            echo "Deployment completed successfully!"
            echo "Site: https://jpathnec.com"
            echo "Deployed at: $(date)"
            echo "================================================"
