name: Deploy to GO54 Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual deployment from GitHub Actions tab

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy to GO54 Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "================================================"
            echo "ğŸš€ Starting deployment to jpathnec.com"
            echo "================================================"
            
            echo "ğŸ“‚ Navigating to project directory..."
            cd /home2/jpathne1/public_html
            
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            echo "ğŸ“¦ Installing Composer dependencies..."
            /opt/cpanel/ea-php83/root/usr/bin/php composer.phar install --no-dev --optimize-autoloader --no-interaction
            
            echo "ğŸ“¦ Installing Node.js dependencies..."
            npm ci --production
            
            echo "ğŸ¨ Building frontend assets with Vite..."
            npm run build
            
            echo "ğŸ—„ï¸ Running database migrations..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan migrate --force
            
            echo "ğŸ§¹ Clearing application cache..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan config:clear
            /opt/cpanel/ea-php83/root/usr/bin/php artisan cache:clear
            /opt/cpanel/ea-php83/root/usr/bin/php artisan route:clear
            /opt/cpanel/ea-php83/root/usr/bin/php artisan view:clear
            
            echo "âš¡ Rebuilding optimized cache..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan config:cache
            /opt/cpanel/ea-php83/root/usr/bin/php artisan route:cache
            /opt/cpanel/ea-php83/root/usr/bin/php artisan view:cache
            
            echo "ğŸ”„ Restarting queue workers..."
            /opt/cpanel/ea-php83/root/usr/bin/php artisan queue:restart
            
            echo "ğŸ” Setting proper permissions..."
            chmod -R 775 storage bootstrap/cache
            
            echo "================================================"
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Site: https://jpathnec.com"
            echo "ğŸ•’ Deployed at: $(date)"
            echo "================================================"
